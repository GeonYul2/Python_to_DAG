
---

```md
# docs/failure_scenarios.md
# 실패 시나리오 수집 (API 실패, 스키마 변경, backfill, 멱등성)

## 0) 목적
실패를 “운”이나 “환경탓”으로 처리하지 않고,
- 재현 가능한 증거(로그/테스트)
- 원인 분류(P0~P3)
- 대응 규칙(자동/수동)
을 누적해 운영 비용을 줄인다.

---

## 1) 공통 원인 태그 (P0~P3)
- P0: 계약 위반(버전/의존성/보안/데이터 파괴 위험)
- P1: DAG import/파싱 실패, 런타임 치명 오류
- P2: 호환성 경고/규칙 위반/품질 이슈(운영 리스크)
- P3: 문서/스타일/경미한 개선

---

## 2) 시나리오 템플릿 (추가 시 복붙)
- ID: FS-YYYYMMDD-###  
- 태그: P0/P1/P2/P3  
- 증상: (무슨 에러/현상)  
- 탐지: (어떤 테스트/모니터링/로그로 잡힘)  
- 원인: (왜 발생)  
- 대응: (즉시 조치 / 장기 조치)  
- 예방: (게이트/계약/테스트 추가)  

---

## 3) 대표 실패 시나리오 목록

### FS-API-001: 외부 API 장애 / 타임아웃
- 태그: P1
- 증상: 요청 타임아웃, 5xx, 빈 응답
- 탐지: fetch 단계 로그 `event=fetch_failed`, 재시도 초과
- 원인: 일시적 장애 / rate limit / 네트워크
- 대응(즉시):
  - 지수 백오프 재시도(최대 N회)
  - 429/5xx 분기 처리
  - 실패 시 “부분 성공” 저장(가능한 경우)
- 예방:
  - 재시도 정책을 코드/설정으로 표준화
  - 실패 시에도 멱등하게 재실행 가능하도록 raw 저장 규칙 준수

### FS-API-002: Rate Limit(429) / 쿼터 초과
- 태그: P1
- 증상: 429 응답, 헤더에 rate limit 정보
- 탐지: 상태코드 기반 분기 로그
- 대응:
  - 헤더 기반 대기(가능하면)
  - 동시성 낮추기, 요청 단위 배치
- 예방:
  - “수집 단위”를 계약으로 고정(페이지/날짜 범위)
  - backfill 시 throttle 강제

### FS-SCHEMA-001: 응답 스키마 변경(필드 추가/삭제/타입 변경)
- 태그: P1 또는 P2(영향도에 따라)
- 증상: KeyError, 타입 캐스팅 실패, null 폭증
- 탐지:
  - 스키마 검증 단계(권장: processed 생성 직전)에서 필드 체크
  - `event=schema_mismatch` 로그
- 대응:
  - 누락 필드는 `null`로 채우되, “버전 업” 필요 시 v2로 분기
  - 다운스트림 깨지면 즉시 롤백 또는 스키마 버전 분리
- 예방:
  - `docs/design/PYTHON_INPUT_SPEC.md`에 필수/선택 필드 정의
  - “스키마 스냅샷 테스트” 추가(샘플 응답 기반)

### FS-BACKFILL-001: Backfill 중 중복 적재(멱등성 위반)
- 태그: P0 (데이터 오염)
- 증상: 동일 날짜/키 데이터 중복, 지표 급등
- 탐지:
  - 로드 단계에서 unique key 중복 체크
  - 적재 전후 row count 급증 경고
- 대응:
  - upsert/merge 전략으로 변경(가능한 저장소 기준)
  - 중복 데이터 정리 스크립트(운영용) 마련
- 예방:
  - raw는 append 허용 가능하되, processed/load는 **멱등 키** 강제
  - “재실행 시 결과 동일” 테스트 케이스 추가

### FS-AIRFLOW-001: DAG import 실패(DagBag) / 파싱 타임아웃
- 태그: P1
- 증상: Airflow UI에 DAG 미표시, import error, timeout
- 탐지: `tests/post/test_dag_import.py` (DagBag import error 0)
- 원인: 잘못된 import, 환경 의존 코드, 너무 무거운 top-level 실행
- 대응:
  - DAG top-level에서 네트워크/파일 I/O 금지
  - import 시 계산/로딩을 lazy하게(Operator 내부로 이동)
- 예방:
  - DagBag 테스트를 CI에 고정
  - `dagbag_import_timeout` 관련 가이드 문서화

### FS-DEPS-001: provider/의존성 버전 불일치(환경 계약 위반)
- 태그: P0
- 증상: 설치 실패, ImportError, Airflow 최소버전 요구 충돌
- 탐지: CI 설치 단계 또는 Post Gate import 실패
- 대응:
  - `contracts/environment.yaml`로 돌아가서 버전 핀 재정렬
  - provider는 타겟 Airflow 최소지원 버전 확인 후 고정
- 예방:
  - “의존성 변경은 계약 변경” 원칙 강제(PR 템플릿/게이트)

---

## 4) 운영 규칙 (실패 발생 시)
1) 실패는 먼저 P0~P3로 태깅한다  
2) 로그 20줄 내로 “재현 단서”를 남긴다  
3) 필요하면 `FS-*` 항목을 추가한다(짧게라도)  
4) 같은 유형이 2번 반복되면 **게이트/계약/테스트** 중 하나를 반드시 강화한다
