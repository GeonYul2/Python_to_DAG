```md
# Agent Spec — PYTHON_TO_DAG (Core)

## 0. Objective
Pipeline Definition(Python/YAML)을 입력으로 받아,
- 검증 가능한 IR 생성
- 운영 가능한 Airflow DAG 코드 생성
을 수행하는 코어 모듈을 구현한다.

---

## 1. Interfaces

### 1.1 CLI (권장)
- `python -m python_to_dag build --input pipelines/yaml/foo.yaml --out dags/`
- `python -m python_to_dag validate --input pipelines/python/foo.py`
- `python -m python_to_dag diff --input ...` (생성물 변경 비교)

### 1.2 Library API
- `parse_to_ir(input_path) -> IR`
- `validate_ir(ir) -> ValidationResult`
- `generate_dag(ir, out_dir) -> GeneratedArtifact`

---

## 2. Parsing Rules

### 2.1 YAML → IR
- YAML schema는 `docs/07_config_schema.md`를 따른다.
- tasks는 입력 순서가 아니라 `task_id` 정렬 + upstream 기반 topo sort를 기본으로 한다.
- upstream이 누락되면 독립 태스크로 간주하되, “의도 확인” 경고를 낸다.

### 2.2 Python → IR
- 파이프라인 정의는 “명시적 데코레이터/등록 방식”만 허용 (암묵적 코드 분석 금지)
  - 예: `@pipeline(id="...")`, `@task(id="...")`
- 이유: 정적 분석 기반 자동 의존성 추론은 오작동/비결정성을 유발할 가능성이 높음.

---

## 3. Validation Rules (Hard Fail)
- task_id naming 규칙 위반 (docs/05 참고)
- 순환 의존성
- Airflow 금지 패턴:
  - 태스크에서 대용량 XCom
  - 로컬 임시경로 하드코딩
  - 실행일자 경계 실수 유발하는 date parsing
- required config 누락:
  - schedule, start_date, owner (default 허용 범위 내)
  - output contract가 필요한 task에 contract 누락

---

## 4. Codegen Rules
- 템플릿 기반 생성 (Jinja 등)
- 공통 defaults는 DAG 레벨에서 설정, task-level override만 허용
- on_failure_callback은 공통 util을 반드시 사용
- logging wrapper를 통해 callable 실행 (start/end/exception 표준화)

---

## 5. Compatibility Guardrails
- Airflow 주요 기능(예: Dataset 스케줄, TaskFlow API, dynamic mapping)은
  “옵션”으로 제공하고, 사용 시 최소 버전 요구사항을 명시한다.
- 구현물은 “현재 프로젝트에서 합의한 Airflow 버전 범위” 내에서만 문법을 사용한다.
  - 버전 범위는 `docs/04_airflow_dag_guidelines.md`의 “Compatibility Matrix”를 따른다.

---

## 6. Determinism Guarantees
- task 정렬, dict 정렬, 템플릿 렌더링 모두 고정 규칙
- 코드 포맷터(black/ruff 등) 적용 결과가 항상 동일해야 한다
- 생성된 DAG에 “Generated by python_to_dag vX.Y.Z” 헤더를 포함

---

## 7. Minimal Reference Pipelines (Required)
1) `youtube_transcript_to_report` (API I/O + LLM)
2) `daily_channel_digest` (멀티 비디오 + 집계)

각 파이프라인은 YAML/Python 버전 둘 다 제공 가능하면 최상.